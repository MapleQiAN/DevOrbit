# GitHub OAuth å¿«é€Ÿå‚è€ƒæŒ‡å—

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### 1. è·å– GitHub OAuth å‡­è¯

è®¿é—® https://github.com/settings/developers â†’ "New OAuth App"

**å¡«å†™ä¿¡æ¯**:
- Application name: `DevOrbit`
- Homepage URL: `http://localhost:13233`
- Authorization callback URL: `http://localhost:13233/auth/github/callback`

**è·å–å‡­è¯**:
- Client ID
- Client Secret

### 2. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `backend/.env`:

```env
GITHUB_CLIENT_ID=your_client_id_here
GITHUB_CLIENT_SECRET=your_client_secret_here
GITHUB_REDIRECT_URI=http://localhost:13233/auth/github/callback
```

### 3. å¯åŠ¨åç«¯

```bash
cd backend
python -m uvicorn app.main:app --reload
```

### 4. æµ‹è¯• OAuth æµç¨‹

#### æ–¹å¼ A: ä½¿ç”¨ API æ–‡æ¡£ï¼ˆæ¨èï¼‰

1. æ‰“å¼€ http://localhost:8000/docs
2. æ‰¾åˆ° `/auth/github/login` ç«¯ç‚¹
3. ç‚¹å‡» "Try it out" â†’ "Execute"
4. å¤åˆ¶è¿”å›çš„ `authorization_url`
5. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤ URL
6. æˆæƒåï¼ŒGitHub ä¼šé‡å®šå‘åˆ°å›è°ƒ URL
7. æ‰‹åŠ¨è®¿é—® `/auth/github/callback?code=<code>` å®Œæˆæµç¨‹

#### æ–¹å¼ B: ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
cd backend
python test_oauth.py
```

#### æ–¹å¼ C: ä½¿ç”¨ curl

```bash
# 1. è·å–æˆæƒ URL
curl http://localhost:8000/auth/github/login

# 2. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¿”å›çš„ authorization_url
# 3. æˆæƒåï¼ŒGitHub é‡å®šå‘åˆ°å›è°ƒ URLï¼Œæå– code å‚æ•°
# 4. è°ƒç”¨å›è°ƒç«¯ç‚¹
curl "http://localhost:8000/auth/github/callback?code=<code>"
```

---

## ğŸ“‹ API ç«¯ç‚¹è¯¦è§£

### GET /auth/github/login

**åŠŸèƒ½**: è·å– GitHub OAuth æˆæƒ URL

**è¯·æ±‚**:
```bash
curl http://localhost:8000/auth/github/login
```

**å“åº”**:
```json
{
  "authorization_url": "https://github.com/login/oauth/authorize?client_id=xxx&..."
}
```

**è¯´æ˜**:
- å‰ç«¯è°ƒç”¨æ­¤ç«¯ç‚¹
- è·å–æˆæƒ URL
- è·³è½¬åˆ° GitHub æˆæƒé¡µé¢

---

### GET /auth/github/callback

**åŠŸèƒ½**: å¤„ç† OAuth å›è°ƒï¼Œäº¤æ¢ tokenï¼Œåˆ›å»ºç”¨æˆ·ï¼Œç­¾å‘ JWT

**è¯·æ±‚å‚æ•°**:
- `code` (å¿…éœ€): GitHub OAuth æˆæƒç 
- `state` (å¯é€‰): CSRF é˜²æŠ¤çŠ¶æ€ç 

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl "http://localhost:8000/auth/github/callback?code=abc123"
```

**å“åº”**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "github_id": 12345678,
    "github_login": "octocat",
    "avatar_url": "https://avatars.githubusercontent.com/u/1?v=4",
    "created_at": "2025-12-09T11:50:21.9513233",
    "updated_at": "2025-12-09T11:50:21.9513233"
  }
}
```

**è¯´æ˜**:
- è¿”å›çš„ `access_token` æ˜¯ JWT token
- å‰ç«¯åº”å°†å…¶å­˜å‚¨åˆ° localStorage
- åç»­è¯·æ±‚æ—¶ï¼Œåœ¨ Authorization header ä¸­ä½¿ç”¨ï¼š`Authorization: Bearer <token>`

---

## ğŸ” ä½¿ç”¨ JWT Token

### å­˜å‚¨ Token

```javascript
// å‰ç«¯ (JavaScript)
const response = await fetch('http://localhost:8000/auth/github/callback?code=xxx');
const data = await response.json();
localStorage.setItem('access_token', data.access_token);
```

### å‘é€ Token

```javascript
// åœ¨åç»­è¯·æ±‚ä¸­ä½¿ç”¨ token
const token = localStorage.getItem('access_token');
const response = await fetch('http://localhost:8000/github/sync', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
});
```

### åç«¯éªŒè¯ Token

```python
from app.api.deps import get_current_user
from app.models import User

@router.get("/protected")
async def protected_endpoint(current_user: User = Depends(get_current_user)):
    return {"user_id": current_user.id}
```

---

## ğŸ”„ å®Œæ•´ OAuth æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (Vue 3)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    1. ç‚¹å‡»ã€ŒGitHub ç™»å½•ã€æŒ‰é’®
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ è°ƒç”¨ GET /auth/github/login â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  è·å– authorization_url     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ è·³è½¬åˆ° GitHub æˆæƒé¡µé¢      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GitHub æˆæƒé¡µé¢                         â”‚
â”‚                   ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç                        â”‚
â”‚                        ç”¨æˆ·æˆæƒ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ GitHub é‡å®šå‘åˆ°å›è°ƒ URL     â”‚
                  â”‚ ?code=xxx&state=yyy         â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ å‰ç«¯æå– code å‚æ•°          â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ è°ƒç”¨ /auth/github/callback  â”‚
                  â”‚ ?code=xxx                   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åç«¯ (FastAPI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ä½¿ç”¨ code å‘ GitHub äº¤æ¢ access_token                   â”‚
â”‚     POST https://github.com/login/oauth/access_token       â”‚
â”‚                                                             â”‚
â”‚  2. ä½¿ç”¨ access_token è·å–ç”¨æˆ·ä¿¡æ¯                          â”‚
â”‚     GET https://api.github.com/user                        â”‚
â”‚                                                             â”‚
â”‚  3. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·                                â”‚
â”‚     INSERT/UPDATE users                                    â”‚
â”‚                                                             â”‚
â”‚  4. ç­¾å‘ JWT token                                          â”‚
â”‚     jwt.encode({"sub": user_id, "exp": ...})               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ è¿”å› JWT token å’Œç”¨æˆ·ä¿¡æ¯   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ å‰ç«¯å­˜å‚¨ token åˆ° localStorage
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ è·³è½¬åˆ°ä»ªè¡¨ç›˜é¡µé¢            â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è·å– OAuth å‡­è¯æ—¶å‡ºç° "Invalid redirect URI"

**åŸå› **: å›è°ƒ URL ä¸ GitHub åº”ç”¨ä¸­é…ç½®çš„ä¸åŒ¹é…

**è§£å†³**:
1. è®¿é—® https://github.com/settings/developers
2. ç¼–è¾‘åº”ç”¨è®¾ç½®
3. ç¡®ä¿ "Authorization callback URL" ä¸ `.env` ä¸­çš„ `GITHUB_REDIRECT_URI` ä¸€è‡´

### Q2: è°ƒç”¨ /auth/github/callback æ—¶è¿”å› 500 é”™è¯¯

**åŸå› **: å¯èƒ½æ˜¯ GitHub OAuth å‡­è¯é…ç½®ä¸æ­£ç¡®

**è§£å†³**:
1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `GITHUB_CLIENT_ID` å’Œ `GITHUB_CLIENT_SECRET`
2. ç¡®ä¿æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–å¼•å·
3. æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

### Q3: JWT token è¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ

**è§£å†³**:
1. å‰ç«¯æ£€æµ‹åˆ° 401 é”™è¯¯
2. æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ token
3. é‡æ–°è°ƒç”¨ `/auth/github/login` è¿›è¡Œç™»å½•

### Q4: å¦‚ä½•ä¿®æ”¹ JWT è¿‡æœŸæ—¶é—´ï¼Ÿ

ç¼–è¾‘ `.env`:

```env
JWT_EXPIRE_MINUTES=10080  # 7 days
```

æˆ–åœ¨ä»£ç ä¸­æŒ‡å®šï¼š

```python
from datetime import timedelta
token = create_access_token(
    subject=str(user.id),
    expires_delta=timedelta(days=30)
)
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. **æ›´æ”¹ JWT å¯†é’¥**:
   ```env
   JWT_SECRET_KEY=your_very_long_random_secret_key_at_least_32_chars
   ```

2. **ä½¿ç”¨ HTTPS**:
   - æ‰€æœ‰ OAuth æµç¨‹å¿…é¡»ä½¿ç”¨ HTTPS
   - é…ç½® `GITHUB_REDIRECT_URI` ä¸º HTTPS URL

3. **CORS é…ç½®**:
   ```env
   CORS_ORIGINS=["https://yourdomain.com"]
   ```

4. **ä¿æŠ¤ GitHub Token**:
   - ä¸è¦åœ¨å‰ç«¯æš´éœ² GitHub access token
   - åªåœ¨åç«¯å­˜å‚¨å’Œä½¿ç”¨

5. **ä½¿ç”¨ CSRF é˜²æŠ¤**:
   - åœ¨ OAuth æµç¨‹ä¸­ä½¿ç”¨ `state` å‚æ•°
   - éªŒè¯å›è°ƒæ—¶çš„ state å€¼

---

## ğŸ“š ç›¸å…³èµ„æº

- [GitHub OAuth æ–‡æ¡£](https://docs.github.com/en/developers/apps/building-oauth-apps)
- [GitHub API æ–‡æ¡£](https://docs.github.com/en/rest)
- [JWT ä»‹ç»](https://jwt.io/introduction)
- [FastAPI å®‰å…¨æ–‡æ¡£](https://fastapi.tiangolo.com/tutorial/security/)

---

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆ OAuth è®¤è¯åï¼Œå¯ä»¥è¿›å…¥ Stage 3ï¼š

- å®ç° GitHub æ•°æ®åŒæ­¥
- å®ç°æ¯æ—¥ç»Ÿè®¡æŸ¥è¯¢
- å®ç°å‰ç«¯ç™»å½•æµç¨‹

---

**æœ€åæ›´æ–°**: 2025-12-09  
**ç‰ˆæœ¬**: 0.1.0

